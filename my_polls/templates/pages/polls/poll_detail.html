{% extends "base.html" %}
{% load i18n %}
{% load static %}

{% block title %}{% translate "Polls" %}{% endblock title %}

{% block main %}
{% block content %}
<nav aria-label="breadcrumb">
  <ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="{% url 'polls:index' %}">{% translate "Polls" %}</a></li>
    <li class="breadcrumb-item active" aria-current="page">{{ poll.question|truncatechars:30 }}</li>
  </ol>
</nav>
<div class="d-flex justify-content-between align-items-center mb-3">
  <h1 class="mb-0">{% translate "Poll Detail" %}</h1>
  <div>
    <a href="{% url 'polls:index' %}" class="btn btn-outline-secondary me-2">&larr; {% translate "Back to Polls" %}</a>
    <a href="{% url 'polls:edit' poll.id %}" class="btn btn-warning me-2">{% translate "Edit" %}</a>
    <a href="{% url 'polls:delete' poll.id %}" class="btn btn-danger">{% translate "Delete" %}</a>
  </div>
</div>
<p>{% translate "This is the detail page for a poll." %}</p>
<p>{% translate "You can view the details of the poll here." %}</p>

<div class="poll-detail">
  <h2>{{ poll.question }}</h2>
  <div class="choices">
    <ul>
      {% for choice in poll.choice_set.all %}
      <li>{{ choice.choice_text }}</li>
      {% empty %}
      <li>{% translate "No choices available." %}</li>
      {% endfor %}
    </ul>
  </div>
  <div class="chart-container">
    <canvas id="voted-chart"></canvas>
  </div>
  <div>
    <p>Published on: {{ poll.created_at|date:"Y-m-d H:i" }}</p>
    <p>Created by: {{ poll.user }}</p>
  </div>
  <div>
    <label for="vote-url">{% translate "Vote URL:" %}</label>
    <div class="input-group mb-2">
      <input type="text" id="vote-url" value="{{ vote_url }}" readonly class="form-control">
      <button type="button" class="btn btn-outline-secondary" id="copy-btn">{% translate "Copy" %}</button>
    </div>
    <small class="form-text text-muted">{% translate "You can share this URL to allow others to vote." %}</small>
    <a href="{{ vote_url }}" class="btn btn-success mt-2">{% translate "Go to Vote" %}</a>
  </div>
</div>
{% endblock content %}
{% endblock main %}

{% block inline_javascript %}
<script id="labels-data"
    type="application/json">{{ choice_labels|safe }}</script>
  <script id="counts-data"
    type="application/json">{{ choice_counts|safe }}</script>
  <script>
  window.addEventListener('DOMContentLoaded', () => {

  document.getElementById('copy-btn').onclick = function() {
    navigator.clipboard.writeText(document.getElementById('vote-url').value).then(function() {
      Swal.fire({
        icon: 'success',
        title: '{% translate "Copied!" %}',
        showConfirmButton: false,
        timer: 1200
      });
    });
  };

  const choice_labels = JSON.parse(document.getElementById("labels-data").textContent);
  const choice_counts = JSON.parse(document.getElementById("counts-data").textContent);

    const ctx = document.getElementById('voted-chart');
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: choice_labels,
        datasets: [{
          label: '# of Votes',
          data: choice_counts,
          borderWidth: 1
        }]
      },
      options: {
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              stepSize: 10        // ช่องละ 10 หน่วย
            },
          }
        }
      }
    });
  });
</script>
{% endblock inline_javascript %}