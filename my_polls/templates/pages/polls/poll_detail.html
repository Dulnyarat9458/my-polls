{% extends "base.html" %}
{% load i18n %}
{% load static %}

{% block title %}{% translate "Polls" %}{% endblock title %}

{% block main %}
{% block content %}
<h1>{% translate "Poll Detail" %}</h1>
<p>{% translate "This is the detail page for a poll." %}</p>
<p>{% translate "You can view the details of the poll here." %}</p>

<div class="poll-detail">
  <h2>{{ poll.question }}</h2>
  <div class="choices">
    <ul>
      {% for choice in poll.choice_set.all %}
      <li>{{ choice.choice_text }}</li>
      {% empty %}
      <li>{% translate "No choices available." %}</li>
      {% endfor %}
    </ul>
  </div>
  <div class="chart-container">
    <canvas id="voted-chart"></canvas>
  </div>
  <div>
    <p>Published on: {{ poll.created_at|date:"Y-m-d H:i" }}</p>
    <p>Created by: {{ poll.user }}</p>
  </div>
  <div>
    <label for="vote-url">{% translate "Vote URL:" %}</label>
    <input type="text" id="vote-url" value="{{ vote_url }}" readonly class="form-control">
    <small class="form-text text-muted">{% translate "You can share this URL to allow others to vote." %}</small>
    <button class="btn btn-secondary mt-2" id="copy-btn">
      {% translate "Copy Vote URL" %}
    </button>
  </div>
  <div class="text-end">
    <a href="{% url 'votes:vote' poll.pk %}" target="_blank" class="btn btn-info">
      {% translate "Vote Poll" %}
    </a>
    <a href="{% url 'polls:edit' poll.pk %}" class="btn btn-primary">
      {% translate "Edit Poll" %}
    </a>
    <a href="{% url 'polls:delete' poll.pk %}" class="btn btn-danger">
      {% translate "Delete Poll" %}
    </a>
    <a href="{% url 'polls:index' %}" class="btn btn-secondary">
      {% translate "Back to Polls" %}
    </a>
  </div>
  {% endblock content %}
  {% endblock main %}

  {% block inline_javascript %}

  <script id="labels-data"
    type="application/json">{{ choice_labels|safe }}</script>
  <script id="counts-data"
    type="application/json">{{ choice_counts|safe }}</script>
  <script>
  window.addEventListener('DOMContentLoaded', () => {

  document.getElementById('copy-btn').onclick = function() {
    navigator.clipboard.writeText(document.getElementById('vote-url').value).then(function() {
      Swal.fire({
        icon: 'success',
        title: '{% translate "Copied!" %}',
        showConfirmButton: false,
        timer: 1200
      });
    });
  };

  const choice_labels = JSON.parse(document.getElementById("labels-data").textContent);
  const choice_counts = JSON.parse(document.getElementById("counts-data").textContent);

    const ctx = document.getElementById('voted-chart');
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: choice_labels,
        datasets: [{
          label: '# of Votes',
          data: choice_counts,
          borderWidth: 1
        }]
      },
      options: {
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              stepSize: 10        // ช่องละ 10 หน่วย
            },
          }
        }
      }
    });
  });
</script>

  {% endblock inline_javascript %}